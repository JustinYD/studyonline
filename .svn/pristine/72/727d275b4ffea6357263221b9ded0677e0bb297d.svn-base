<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="../Scripts/layui/css/layui.css" />
    <style>
        body {
            padding: 15px;
            overflow-y: scroll;
        }

        img#questionImg {
            width: 300px;
            height: 200px;
            border: 1px solid gray;
        }
    </style>
</head>
<body>
    <div class="layui-form-item">
        <div class="layui-inline">
            <button class="layui-btn" type="button" id="btnBack">
                <i class="layui-icon">&#xe603;</i>
            </button>
        </div>
    </div>
    <form class="layui-form">
        <div class="layui-form-item">
            <label class="layui-form-label">试题名称</label>
            <div class="layui-input-inline"  style="width:500px;">
                <input type="text" name="QuestionName" id="QuestionName" lay-verify="required" autocomplete="off" placeholder="请输入试题名称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">试题编号</label>
            <div class="layui-input-inline">
                <input type="text" name="Number" id="Number" lay-verify="required" autocomplete="off" placeholder="请输入试题编号" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">试题分值</label>
            <div class="layui-input-inline">
                <input type="text" name="QuestionScore" id="QuestionScore" lay-verify="required|double" autocomplete="off" placeholder="请输入试题分值" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">试题图片</label>
            <div class="layui-input-block">
                <div class="layui-upload">
                    <div class="layui-upload-list">
                        <img class="layui-upload-img" id="questionImg" />
                        <p id="errorMsg">
                        </p>
                    </div>
                    <input type="hidden" id="HdQuestionImg" name="QuestionImg" />
                    <button type="button" class="layui-btn" id="btnUploadImg">
                        上传图片
                    </button>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">试题类型</label>
            <div class="layui-input-block  layui-form"  lay-filter="rbtQuestionTypes">
                <input type="radio" lay-filter="QuestionType" name="QuestionType" value="1" title="单选" checked="">
                <input type="radio" lay-filter="QuestionType" name="QuestionType" value="2" title="多选">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">选项</label>
            <div class="layui-input-block">
                <div class="answerArea layui-form" lay-filter="answers">


                </div>
                <button type="button" class="layui-btn" id="btnAddAnswer">添加选项</button>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="submit">
                    立即提交
                </button>
                <button type="reset" class="layui-btn layui-btn-primary">
                    重置
                </button>
            </div>
        </div>
    </form>
    <script type="text/javascript" src="../scripts/layui/layui.js"></script>
    <script>
        layui.use(["form", "upload"], function () {
            var form = layui.form, $ = layui.jquery, upload = layui.upload;
            form.verify({
                double: [/^-?[0-9]*(\.\d*)?$|^-?d^(\.\d*)?$/, '分值格式错误']
            });

            //普通图片上传
            var uploadInst = upload.render({
                elem: '#btnUploadImg'
                , url: '../tools/ImgUploader.ashx'
                , before: function (obj) {
                    //预读本地文件示例，不支持ie8
                    obj.preview(function (index, file, result) {
                        $('#questionImg').attr('src', result); //图片链接（base64）
                    });
                }
                , done: function (res) {
                    //如果上传失败
                    if (res.code > 0) {
                        return layer.msg('上传失败');
                    }
                    //上传成功
                    $("#HdQuestionImg").val(res.data.src)
                }
                , error: function () {
                    //演示失败状态，并实现重传
                    var demoText = $('#errorMsg');
                    demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
                    demoText.find('.demo-reload').on('click', function () {
                        uploadInst.upload();
                    });
                }
            });
            var _param = { type: 1 };
            var _handlers = {
                _ADDANSWER: function () {
                    var type = $("input[type=radio][name='QuestionType']:checked").val();
                    var html = "";
                    var len = $("div[_target='answer']").length;
                    var guid = _handlers._GUID();
                    if (type == "1") { //单选
                        html += "<div class=\"layui-form-item\" _target='answer'>";
                        html += "<label class=\"layui-form-label\" _target=\"itemName\">选项" + (len + 1) + "</label>";
                        html += "<div class=\"layui-input-inline\" style='width:400px;'>";
                        html += "<input type=\"text\" name=\"answer\" _target=\"answerItem\" id=\"" + guid + "\" lay-verify=\"required\" autocomplete=\"off\" placeholder=\"请输入选项内容\" class=\"layui-input\" />";
                        html += "</div><input type=\"radio\" value=\"1\" name=\"isRight\" lay-skin=\"primary\" title=\"正确选项\" " + (len == 0 ? "checked" : "") + " /><button class=\"layui-btn layui-btn-radius  layui-btn-danger\" _target=\"delete\" _val=\""+guid+"\" type=\"button\" ><i class=\"layui-icon\">&#xe640;</i></button>";
                        html += "</div>";
                        $("div.answerArea").append(html);
                        form.render('radio', 'answers');
                    } else { //多选
                        html += "<div class=\"layui-form-item\" _target='answer'>";
                        html += "<label class=\"layui-form-label\" _target=\"itemName\">选项" + (len + 1) + "</label>";
                        html += "<div class=\"layui-input-inline\" style='width:400px;'>";
                        html += "<input type=\"text\" name=\"answer\" _target=\"answerItem\" id=\"" + guid + "\" lay-verify=\"required\" autocomplete=\"off\" placeholder=\"请输入选项内容\" class=\"layui-input\" />";
                        html += "</div><input type=\"checkbox\" value=\"1\" name=\"isRight\" lay-skin=\"primary\" title=\"正确选项\" /><button class=\"layui-btn layui-btn-radius  layui-btn-danger\"  _target=\"delete\"  _val=\"" + guid + "\"   type=\"button\" ><i class=\"layui-icon\">&#xe640;</i></button>";
                        html += "</div>";
                        $("div.answerArea").append(html);
                        form.render('checkbox', 'answers');
                    }
                    $("div.answerArea button[_target='delete']").unbind("click").bind("click", function () {
                        var t = this;
                        layer.confirm('确定要删除该选项？', { icon: 3, title: '提示' }, function (index) {
                            layer.close(index);
                            $(t).parent().fadeOut("slow", function () {
                                $(t).parent().remove();
                                $("div[_target='answer']").each(function (i) {
                                    $(this).find("label[_target='itemName']").html("选项" + (i + 1));
                                });
                            });
                        });
                    });
                },
                _GUID: function () {
                    var guid = "";
                    for (var i = 1; i <= 32; i++) {
                        var n = Math.floor(Math.random() * 16.0).toString(16);
                        guid += n;
                        if ((i == 8) || (i == 12) || (i == 16) || (i == 20))
                            guid += "-";
                    }
                    return guid;
                },
                getQueryString: function (name) {
                    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                    var r = window.location.search.substr(1).match(reg);
                    if (r != null) return unescape(r[2]); return null;
                },
                GETDETAIL: function () {
                    $("#btnBack").click(function () {
                        window.location.href = "questions.html?id=" + _handlers.getQueryString("stkid");
                    })
                    var questionGuid = _handlers.getQueryString("qid")
                    if (questionGuid) {
                        var loadingIndex = layer.load(0, { shade: [0.5, '#fff'] });
                        $.ajax({
                            url: "../tools/QuestionHandler.ashx",
                            data: { action: "detail", id: questionGuid },
                            dataType: "json",
                            type: "post",
                            success: function (json) {
                                if (json && json.status == 1) {
                                    var obj = json.data;
                                    $("#QuestionName").val(obj["QuestionName"]);
                                    $("#Number").val(obj["Number"]);
                                    $("#QuestionScore").val(obj["QuestionScore"]);
                                    $("#HdQuestionImg").val(obj["QuestionImg"]);
                                    $('#questionImg').attr('src', obj["QuestionImg"]);
                                    _param.type = obj["QuestionType"];
                                    var ii = _param.type == 1 ? 0 : 1;
                                    $("div[lay-filter='rbtQuestionTypes'] div.layui-form-radio")[ii].click();
                                    var answerHtml = "";
                                    for (var i = 0; i < obj.AnswerItem.length; i++) {
                                        var answerObj = obj.AnswerItem[i];
                                        var guid = answerObj["AnswerGuid"];
                                        if (_param.type + "" == "1") { //单选
                                            answerHtml += "<div class=\"layui-form-item\" _target='answer'>";
                                            answerHtml += "<label class=\"layui-form-label\" _target=\"itemName\">选项" + (i + 1) + "</label>";
                                            answerHtml += "<div class=\"layui-input-inline\" style='width:400px;'>";
                                            answerHtml += "<input type=\"text\" name=\"answer\" _target=\"answerItem\" id=\"" + guid + "\" lay-verify=\"required\" value=\"" + answerObj["AnswerName"] + "\" autocomplete=\"off\" placeholder=\"请输入选项内容\" class=\"layui-input\" />";
                                            answerHtml += "</div><input type=\"radio\" value=\"1\" name=\"isRight\" lay-skin=\"primary\" title=\"正确选项\" " + (answerObj["IsRightAnswer"] == 1 ? "checked" : "") + " /><button class=\"layui-btn layui-btn-radius  layui-btn-danger\" _target=\"delete\" _val=\"" + guid + "\" type=\"button\" ><i class=\"layui-icon\">&#xe640;</i></button>";
                                            answerHtml += "</div>";
                                          
                                        } else { //多选
                                            answerHtml += "<div class=\"layui-form-item\" _target='answer'>";
                                            answerHtml += "<label class=\"layui-form-label\" _target=\"itemName\">选项" + (i + 1) + "</label>";
                                            answerHtml += "<div class=\"layui-input-inline\" style='width:400px;'>";
                                            answerHtml += "<input type=\"text\" name=\"answer\" _target=\"answerItem\" id=\"" + guid + "\" lay-verify=\"required\" value=\"" + answerObj["AnswerName"] + "\" autocomplete=\"off\" placeholder=\"请输入选项内容\" class=\"layui-input\" />";
                                            answerHtml += "</div><input type=\"checkbox\" value=\"1\" name=\"isRight\" lay-skin=\"primary\" title=\"正确选项\" " + (answerObj["IsRightAnswer"] == 1 ? "checked" : "") + " /><button class=\"layui-btn layui-btn-radius  layui-btn-danger\"  _target=\"delete\"  _val=\"" + guid + "\"   type=\"button\" ><i class=\"layui-icon\">&#xe640;</i></button>";
                                            answerHtml += "</div>";
                                        }
                                    }
                                    if (_param.type + "" == "1") {
                                        $("div.answerArea").append(answerHtml);
                                        form.render('radio', 'answers');
                                    } else {
                                        $("div.answerArea").append(answerHtml);
                                        form.render('checkbox', 'answers');
                                    }
                                    $("div.answerArea button[_target='delete']").unbind("click").bind("click", function () {
                                        var t = this;
                                        layer.confirm('确定要删除该选项？', { icon: 3, title: '提示' }, function (index) {
                                            layer.close(index);
                                            $(t).parent().fadeOut("slow", function () {
                                                $(t).parent().remove();
                                                $("div[_target='answer']").each(function (i) {
                                                    $(this).find("label[_target='itemName']").html("选项" + (i + 1));
                                                });
                                            });
                                        });
                                    });
                                    layer.close(loadingIndex);
                                }
                            }, error: function () { }
                        })
                    }
                }
            };
            _handlers.GETDETAIL();
            $("#btnAddAnswer").click(function () {
                _handlers._ADDANSWER();
            });

            form.on('radio(QuestionType)', function (data) {
                var val =parseInt(data.value); //被点击的radio的value值
                if (val != _param.type) {
                    layer.confirm('切换试题类型，会清空该试题的选项，确定要切换吗？', { icon: 3, title: '提示' }, function (index) {
                        //do something
                        _param.type = val;
                        layer.close(index);
                        $("div.answerArea").html("");
                    }, function (index) {
                        layer.close(index);
                        var i = _param.type==1?0:1;
                        $("div[lay-filter='rbtQuestionTypes'] div.layui-form-radio")[i].click();
                    });
                }
            });

            form.on('submit(submit)', function (data) {
                var len = $("div[_target='answer']").length;
                if (len > 0) {
                    var questionGuid = _handlers.getQueryString("qid") || "00000000-0000-0000-0000-000000000000";
                    var stkGuid = _handlers.getQueryString("stkid");
                    var obj = data.field;
                    var json = {};
                    json["QuestionGuid"] = questionGuid;
                    json["QuestionName"] = obj["QuestionName"];
                    json["Number"] = obj["Number"];
                    json["QuestionScore"] = obj["QuestionScore"];
                    json["QuestionImg"] = obj["QuestionImg"];
                    json["QuestionType"] = obj["QuestionType"];
                    json["STKGuid"] = stkGuid;
                    var answerJson = [];

                    $("div[_target='answer']").each(function (index) {
                        var answerObj = $(this).find("input[_target='answerItem']");
                        var guid = answerObj.attr("id");
                        var val = answerObj.val();
                        var isRight = 0;
                        if (obj["QuestionType"] == 1) {
                            isRight = $(this).find("input[type='radio']:checked").val() || 0;
                        } else {
                            isRight = $(this).find("input[type='checkbox']:checked").val() || 0;
                        }
                        answerJson.push({ AnswerGuid: guid, AnswerName: val, QuestionGuid: questionGuid, STKGuid: stkGuid, IsRightAnswer: isRight, AnswerOrder: index });
                    });
                    json["AnswerItem"] = answerJson;
                    var i = layer.load(0, { shade: [0.5, '#fff'] });
                    $.ajax({
                        url: "../tools/QuestionHandler.ashx",
                        data: { action: "op", json: JSON.stringify(json)},
                        dataType: "json",
                        type: "post",
                        success: function (json) {
                            layer.close(i);
                            var ii = layer.alert(json.msg, function (index) {
                                layer.close(ii);
                                if (json.status == 1) {
                                    window.location.reload();
                                }
                            });
                        }, error: function () { }
                    })

                } else {
                    layer.msg('请添加试题选项。');
                }
                return false;
            });
        });

    </script>
</body>
</html>
