<!DOCTYPE html>
<html>
<head>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" type="text/css" href="../Scripts/layui/css/layui.css" media="all" />
    <title>答题</title>
</head>
<body>
    <script type="text/javascript" src="../Scripts/layui/layui.js"></script>
    <script>
        layui.use(["form","element"], function () {
            var $ = layui.jquery;
            var _handlers = {
                getQueryString: function (name) {
                    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                    var r = window.location.search.substr(1).match(reg);
                    if (r != null) return unescape(r[2]); return null;
                }
            };
            var examGuid = _handlers.getQueryString("id");
            var s = _handlers.getQueryString("s");
            var uid = _handlers.getQueryString("uid");
            var layerIndex = layer.open({
                type: 2,
                title:"sss",
                maxmin: false,
                content: "paper.html?id=" + examGuid + "&s=" +s + "&uid=" +uid,
                shade: [0.8, '#393D49'],
                btnAlign:"c",
                success: function (index, layero) {
                    layui.data("USERPAPER_" + examGuid + "_" + userGuid, {});//临时存储
                },
                btn: ['确认提交'],
                yes: function (index, layero) {
                    var userGuid = _handlers.getQueryString("uid");
                    var examGuid = _handlers.getQueryString("id");
                    layer.confirm('提交后不可再次进行回答，确认提交试卷？', { icon: 3, title: '提示' }, function (index) {
                        var loadingIndex = layer.load(0, { shade: [0.5, '#fff'] });
                        var submitObj = {};
                        submitObj["ExamGuid"] = examGuid;
                        var paperData = layui.data("USERPAPER_" + examGuid + "_" + userGuid);
                        //alert(JSON.stringify(paperData));
                        var question = [];
                        for (var item in paperData) {
                            var answers = paperData[item];
                            var rightAnswer = answers["RightAnswer"].sort();
                            var selectAnswer = answers["UserAnswers"].sort();
                            var isRight = rightAnswer.Equals(selectAnswer) ? 1 : 0;
                            question.push({ QuestionGuid: item, RightAnswerGuid: answers["RightAnswer"], SelectAnswerGuid: answers["UserAnswers"], IsRight: isRight });
                        }
                        submitObj["Questions"] = question;
                        layer.close(index);
                        $.ajax({
                            url: "../tools/UserPaperHandler.ashx",
                            data: { action: "submitpaper", json: JSON.stringify(submitObj), uid: userGuid },
                            dataType: "json",
                            type: "post",
                            success: function (json) {
                                layer.alert(json.msg, function (alertIndex) {
                                    if (json.status == 1) {
                                        layui.data("USERPAPER_" + examGuid + "_" + userGuid, null); //清除之前的缓存important
                                        layer.close(loadingIndex);
                                        layer.close(alertIndex);
                                        layer.close(layerIndex);
                                    } else {
                                        layer.close(loadingIndex);
                                        layer.close(alertIndex);
                                    }
                                });
                            }
                        });
                    });
                    return false;
                },
                cancel: function () {
                    layer.confirm('是否要放弃答题？', { icon: 2, title: '提示' }, function (index) {
                        layer.close(index);
                        layer.close(layerIndex);
                    });
                    return false;
                }
            });
            layer.full(layerIndex);
        })

    </script>
</body>
</html>
